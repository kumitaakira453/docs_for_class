<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>モデル・管理者サイト(追記事項) | docs_for_class</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="モデル・管理者サイト(追記事項)" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="docs_for_class" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="モデル・管理者サイト(追記事項)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","headline":"モデル・管理者サイト(追記事項)","url":"/regular/webapp-basic-1/basic-django-polls/model-and-admin-site.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d73d2df3aea0474ad31bcfaf19401ed12dcd8a41">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="/">docs_for_class</a></h1>
      

      <h2 id="さらに便利なデータベースの操作">さらに便利なデータベースの操作</h2>

<p><a href="https://be-engineer.tech/docs/regular/webapp-basic-1/basic-django-polls/model-and-admin-site.html#:~:text=%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%80%82-,%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E6%93%8D%E4%BD%9C%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B,-%EF%83%81">教科書</a>で扱った対話モードでのデータベースの操作は、作成したデータベースの挙動をテストする際に非常に有用な方法です。特に今後複雑なデータベースを構築するようになると、データベースにアクセスするコードを書いていても、思い通りには動かないケースを多く出てくると思います。そういった時に、自分が考えたデータベースへのアクセスをテストしながら書いていくことは、開発していく上で大事なスキルになります。
そういった時に用いられるのが<code class="language-plaintext highlighter-rouge">django_shell</code>なのですが、使ってみてわかるように作成した DB を毎回 import する必要があり、さらに django で開発している時は当たり前に備わっている、入力補完機能もついていません。
今回紹介するのは、そういった面倒なことを自動でやってくれる django のパッケージです。
<code class="language-plaintext highlighter-rouge">django-extension</code>の<a href="https://django-extensions.readthedocs.io/en/latest/shell_plus.html"><code class="language-plaintext highlighter-rouge">shell_plus</code></a>と呼ばれる機能を使います。djnagoにもともと入っているものではないので、追加でinstallが必要ですが、一度入れてしまったら非常に便利なので、ぜひ入れておいてください。
導入方法を以下に示します。</p>

<h3 id="shell_plusの導入方法"><code class="language-plaintext highlighter-rouge">shell_plus</code>の導入方法</h3>

<ol>
  <li>ターミナル上で以下を実行し<code class="language-plaintext highlighter-rouge">django-extensions</code>をインストール
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>pip <span class="nb">install </span>django-extensions
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">mysite/settings.py</code>の<code class="language-plaintext highlighter-rouge">INSTALLED_APPS</code>を編集
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
 <span class="s">'django.contrib.admin'</span><span class="p">,</span>
 <span class="s">'django.contrib.auth'</span><span class="p">,</span>
 <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
 <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
 <span class="s">'django.contrib.messages'</span><span class="p">,</span>
 <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
 <span class="s">'django_extensions'</span><span class="p">,</span> <span class="err">←</span><span class="n">ここに追記</span>
 <span class="s">'polls'</span><span class="p">,</span>
 <span class="s">'forum'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>    </div>
  </li>
  <li>最後にターミナル上で shell を起動します
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python manage.py shell_plus
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="管理者画面のカスタマイズ">管理者画面のカスタマイズ</h2>

<p>Django には自動で管理者画面が作成されるという非常に便利な機能がついていますが、さらにこの管理者画面は自分好みにカスタマイズすることができます。特にアプリを個人で作っているとあまり気にしないかもしれませんが、実際に業務として開発を行うようになるとアプリを使う管理者側の立場になると、特定のよく使うデータを見やすく配置することが必要になります。そういった時に向けて、いくつか紹介しておきます。</p>

<h3 id="データベースの表示名を日本語にする">データベースの表示名を日本語にする</h3>

<p>現状では管理者画面で「Question」や「Choice」などの<code class="language-plaintext highlighter-rouge">models.py</code>で定義した名前になっていると思います。（管理者画面の DB 一覧表示ではデフォルトで複数形になっています)
ただ実際にサービスを利用する管理者にとっては日本語で統一しておいたほうがわかりやすいでしょう。そこで<code class="language-plaintext highlighter-rouge">models.py</code>の設定を変更して日本語表示にして見ましょう。
ついでに field も日本語表示するようにコードを変更しています。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">question_text</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="s">"質問内容"</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="s">"公開日"</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s">"質問"</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s">"質問一覧"</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">question_text</span>


<span class="k">class</span> <span class="nc">Choice</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="p">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">choice_text</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="s">"選択肢"</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">votes</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="s">"投票数"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s">"選択肢"</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s">"選択肢一覧"</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">choice_text</span>
</code></pre></div></div>

<h4 id="コードの簡単な解説">コードの簡単な解説</h4>

<ol>
  <li>DB クラス自体の表示名を変更する
<code class="language-plaintext highlighter-rouge">class Meta</code>というクラスを作りその中に<code class="language-plaintext highlighter-rouge">verbose_name</code>,<code class="language-plaintext highlighter-rouge">verbose_name_plural</code>にそれぞれ値を設定します。それぞれ管理者画面で表示するときの単数形、複数形を指定することができます</li>
  <li>DB クラス内のそれぞれの field の表示名を変更する
それぞれの field を定義したコードの第一引数に表示名を追加することで変更できます。</li>
</ol>

<h4 id="変更の反映">変更の反映</h4>

<p>基本的には DB 自体の構造を変えたわけではないので、変更を保存し管理者画面をリロードすることで変化を確認できます。</p>

<h3 id="それぞれの-db-の一覧表示でかく-field-も見れるようにする">それぞれの DB の一覧表示でかく field も見れるようにする</h3>

<p>Question や Choice の一覧を表示するページには、<code class="language-plaintext highlighter-rouge">__str__</code>で登録した形式で DB についての情報が書かれていますが、実際にそれぞれの field の情報を確認しようとすると、それぞれを選択して別の画面を開く必要があります。特定の field の値を全て確認したいというときに不便です。そこで一覧画面でも全ての field が閲覧できるように編集してみましょう。<code class="language-plaintext highlighter-rouge">admin.py</code>を以下のように変更してください。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Question</span><span class="p">,</span> <span class="n">Choice</span>


<span class="c1">#教科書に沿って書いた以下の二行はコメントアウトする
#admin.site.register(Question)
#admin.site.register(Choice)
</span>


<span class="o">@</span><span class="n">admin</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">Question</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">QuestionAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'question_text'</span><span class="p">,</span> <span class="s">'pub_date'</span><span class="p">)</span>


<span class="o">@</span><span class="n">admin</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">Choice</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ChoiceAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'question'</span><span class="p">,</span> <span class="s">'choice_text'</span><span class="p">,</span> <span class="s">'votes'</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="コードの簡単な説明">コードの簡単な説明</h4>
<p>Djangoが提供してくれている管理者画面をそのまま使う場合は、教科書のように一行書くだけでいいのですが、設定の一部を変更する際には以下のようにそれぞれをクラスとして書く直す必要があります。それぞれのクラスに対して<code class="language-plaintext highlighter-rouge">list_display</code>という<code class="language-plaintext highlighter-rouge">タプル</code>を宣言し、一覧表示で見れるようにしたいfield名をその中に追加することで、一覧表示の設定を変更することができます。</p>

<h3 id="question-を作った時に-choice-も一緒に作成できるようにする">Question を作った時に Choice も一緒に作成できるようにする</h3>

<p>現在の使用ではそれぞれの DB クラスごとに管理者画面の別々のページで作成する必要がありますが、Question を作ってから、それに紐ずく Choice を毎回別のページを開いて作成するのは面倒です。以下のよう<code class="language-plaintext highlighter-rouge">admin.py</code>を変更することで Question を作成する画面に Choice を作成する部分を追加することができます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Question</span><span class="p">,</span> <span class="n">Choice</span>

<span class="c1">#教科書に沿って書いた以下の二行はコメントアウトする
#admin.site.register(Question)
#admin.site.register(Choice)
</span>
<span class="c1">#他の DB 作成画面で表示する用の Choice 作成部分(インラインと呼ぶ)を作る
</span><span class="k">class</span> <span class="nc">ChoiceInline</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Choice</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 空の追加フィールドを 1 つ表示
</span>
<span class="o">@</span><span class="n">admin</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">Question</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">QuestionAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'question_text'</span><span class="p">,</span> <span class="s">'pub_date'</span><span class="p">)</span> <span class="c1"># インライン(一緒に表示する部分)として登録
</span>    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ChoiceInline</span><span class="p">]</span>

<span class="o">@</span><span class="n">admin</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">Choice</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">ChoiceAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'question'</span><span class="p">,</span> <span class="s">'choice_text'</span><span class="p">,</span> <span class="s">'votes'</span><span class="p">)</span> <span class="c1"># 一覧で表示するフィールド
</span>
</code></pre></div></div>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
